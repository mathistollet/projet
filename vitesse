#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <time.h>
#define RESET   "\033[0m"
#define RED     "\033[0;31m"
#define GREEN   "\033[0;32m"
#define ORANGE  "\033[38;5;208m"

typedef enum {
    tank, assassin, soutien
} Type;

typedef struct {
    char nom[30];
    int degats;
} Attaque;

typedef struct {
    char nom[50];
    int pvc;
    int pvm;
    int def;
    float agl;
    float vitess;
    float barre_action;
    Attaque att[2];
    Type type;
} Champion;

const char* lesroles(Type type) {
    switch (type) {
        case 0: return "tank";
        case 1: return "assassin";
        case 2: return "soutien";
        default: return "inconnu";
    }
}

void afficherBarreDeVie(int pvact, int pvmax) {
    int longueurBarre = 20;
    int nbBlocs = (pvact * longueurBarre) / pvmax;
    float ratio = (float)pvact / pvmax;

    const char *couleur;

    if (ratio > 0.6) couleur = GREEN;
    else if (ratio > 0.3) couleur = ORANGE;
    else couleur = RED;

    printf("[");
    for (int i = 0; i < longueurBarre; i++) {
        if (i < nbBlocs)
            printf("%s█", couleur);
        else
            printf("%s ", RESET);
    }
    printf("%s] %d/%d PV\n", RESET, pvact, pvmax);
}

void afficherBarreDeVitesse(float barre_action) {
    int longueurBarre = 20;
    int nbBlocs = (barre_action * longueurBarre) / 100;  // 100 est la valeur max de la barre d'action

    printf("[");
    for (int i = 0; i < longueurBarre; i++) {
        if (i < nbBlocs)
            printf("%s█", GREEN);  // Vitesse en vert
        else
            printf("%s ", RESET);  // Réinitialise à la couleur par défaut
    }
    printf("] %.2f/100 Vitesse\n", barre_action);
}


void afficherVie(Champion p1, Champion p2) {
    printf("\n--- ÉTAT DES COMBATTANTS ---\n");
    printf("%s : ", p1.nom);
    afficherBarreDeVie(p1.pvc, p1.pvm);
    afficherBarreDeVitesse(p1.barre_action);

    printf("%s : ", p2.nom);
    afficherBarreDeVie(p2.pvc, p2.pvm);
    afficherBarreDeVitesse(p2.barre_action);
    printf("\n");
}

int esquive(int chance) {
    if ((rand() % 101) >chance){
     return 1;
    }
     else{
        return 0;
     }
    
}


void utiliserAttaque(Champion *attaquant, Champion *cible, Attaque a) {
    if (esquive(cible->agl)==0){
        printf("\n mince il a esquivé aussi vite que chloe prime qui descend les escalier \n");
    }
    else{
    printf("%s utilise %s et inflige %d dégâts à %s !\n", attaquant->nom, a.nom, a.degats, cible->nom);
    cible->pvc =  cible->pvc- a.degats+cible->def;
    if (cible->pvc < 0) cible->pvc = 0;
    }
}

void soigner(Champion* c) {
    int soin = 30;
    c->pvc += soin;
    if (c->pvc > c->pvm) c->pvc = c->pvm;
    printf("%s se soigne et récupère %d PV !\n", c->nom, soin);
}


void combat(Champion* perso1, Champion *perso2) {
    int choix;

    // Tour du joueur 1
    printf("== Ton tour (%s) ==\n", perso1->nom);
    for (int i = 0; i < 2; i++) {
        printf("%d - %s (dégâts : %d)\n", i + 1, perso1->att[i].nom, perso1->att[i].degats);
    }
    if (perso1->type == soutien) {
        printf("3 - Se soigner\n");
    }

    printf("Choisis une action : ");
    scanf("%d", &choix);
    

    if (choix >= 1 && choix <= 2) {
        utiliserAttaque(perso1, perso2, perso1->att[choix - 1]);
    } else if (choix == 3 && perso1->type == soutien) {
        soigner(perso1);
    } else {
        printf("Choix invalide, tu perds ton tour !\n");
    }

    if (perso2->pvc <= 0) return;
}
    
    
    
    
    
    

    // Tour du joueur 2
    
int main() {
    srand(time(NULL));
    Champion a = {"titeuf", 350, 350, 10, 20, 6,0, {{"Coup de poing", 50}, {"Lame magique", 25}}, tank};
    Champion b = {"manu", 300, 300, 10, 20, 4,0, {{"lunette", 50}, {"boucle", 30}}, soutien};

 while (a.pvc > 0 && b.pvc > 0) {
        // Mise à jour de la barre d'action de chaque personnage
        a.barre_action += a.vitess;
        b.barre_action += b.vitess;

        afficherVie(a, b);

        // Si un personnage est prêt à jouer (barre d'action >= 100), il agit
        if (a.barre_action >= 100 && a.pvc > 0) {
            printf("\n>>> %s est prêt à jouer !\n", a.nom);
            combat(&a, &b);
            a.barre_action = 0; // Réinitialisation de la barre d'action
        }

        if (b.barre_action >= 100 && b.pvc > 0) {
            printf("\n>>> %s est prêt à jouer !\n", b.nom);
            combat(&b, &a);
            b.barre_action = 0; // Réinitialisation de la barre d'action
        }
    }






    afficherVie(a, b);

    // Affichage du gagnant
    if (a.pvc > 0) {
        printf("%s a gagné !\n", a.nom);
    } 
    else if (b.pvc > 0) {
        printf("%s a gagné !\n", b.nom);
    } 
    else {
        printf("Match nul !\n");
    }

    return 0;
}
